<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Multi-Payment Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .chart-container {
            height: 300px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 5px;
        }
        .success-message {
            color: #10b981;
            font-size: 14px;
            margin-top: 5px;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="text-center">
                <i class="fas fa-user-shield text-4xl text-blue-600 mb-4"></i>
                <h2 class="text-2xl font-bold mb-6">Admin Login</h2>
                <p class="text-gray-600 mb-6">Please enter your credentials</p>
                <form id="loginForm">
                    <div class="mb-4">
                        <input type="text" id="username" placeholder="Username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </button>
                </form>
                <div id="loginError" class="error-message" style="display: none;"></div>
                <div class="mt-4 text-sm text-gray-500">
                    <p>Admin: admin / admin123</p>
                    <p>User: user / user123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Header -->
        <div class="bg-white shadow-lg no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-credit-card text-3xl text-blue-600 mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Multi-Payment Dashboard</h1>
                            <p class="text-gray-600">PayPal, Stripe, PKR & Custom Merchant Management</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-file-excel mr-2"></i>Export All Data
                        </button>
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-600">Welcome back</span>
                            <span id="userRole" class="font-bold text-blue-600"></span>
                        </div>
                        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Balance Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">PKR Balance</p>
                            <p class="text-xs text-gray-500">Current available balance</p>
                            <p class="text-2xl font-bold text-blue-600" id="pkrBalance">0 PKR</p>
                        </div>
                        <i class="fas fa-wallet text-3xl text-blue-600"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total USD</p>
                            <p class="text-2xl font-bold text-green-600" id="totalUSD">$0</p>
                        </div>
                        <i class="fas fa-dollar-sign text-3xl text-green-600"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total PKR</p>
                            <p class="text-2xl font-bold text-purple-600" id="totalPKR">0 PKR</p>
                        </div>
                        <i class="fas fa-coins text-3xl text-purple-600"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Transactions</p>
                            <p class="text-2xl font-bold text-orange-600" id="totalTransactions">0</p>
                        </div>
                        <i class="fas fa-exchange-alt text-3xl text-orange-600"></i>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Monthly Revenue Trend</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Payment Methods Distribution</h3>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Transaction Tables -->
            <div class="space-y-8">
                <!-- PayPal USD Transactions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">PayPal USD Transactions</h3>
                        <button id="addPaypalBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 no-print">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2 text-left">Date</th>
                                    <th class="px-2 py-2 text-left">Client Name</th>
                                    <th class="px-2 py-2 text-left">Amount</th>
                                    <th class="px-2 py-2 text-left">Net Amount</th>
                                    <th class="px-2 py-2 text-left">PKR Total</th>
                                    <th class="px-2 py-2 text-left">Invoice #</th>
                                    <th class="px-2 py-2 text-left">Invoice Status</th>
                                    <th class="px-2 py-2 text-left">Invoice Date</th>
                                    <th class="px-2 py-2 text-left no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paypalTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Stripe USD Transactions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Stripe USD Transactions</h3>
                        <button id="addStripeBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 no-print">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2 text-left">Date</th>
                                    <th class="px-2 py-2 text-left">Client Name</th>
                                    <th class="px-2 py-2 text-left">Amount</th>
                                    <th class="px-2 py-2 text-left">Net Amount</th>
                                    <th class="px-2 py-2 text-left">PKR Total</th>
                                    <th class="px-2 py-2 text-left">Invoice #</th>
                                    <th class="px-2 py-2 text-left">Invoice Status</th>
                                    <th class="px-2 py-2 text-left">Invoice Date</th>
                                    <th class="px-2 py-2 text-left no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stripeTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PKR Transactions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">PKR Transactions</h3>
                        <button id="addPkrBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 no-print">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2 text-left">Date</th>
                                    <th class="px-2 py-2 text-left">Client Name</th>
                                    <th class="px-2 py-2 text-left">PKR Amount</th>
                                    <th class="px-2 py-2 text-left">Purpose</th>
                                    <th class="px-2 py-2 text-left no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pkrTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Custom Merchants -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Custom Merchants</h3>
                        <button id="addCustomBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 no-print">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2 text-left">Date</th>
                                    <th class="px-2 py-2 text-left">Client Name</th>
                                    <th class="px-2 py-2 text-left">Amount</th>
                                    <th class="px-2 py-2 text-left">Currency</th>
                                    <th class="px-2 py-2 text-left">Merchant</th>
                                    <th class="px-2 py-2 text-left">Invoice #</th>
                                    <th class="px-2 py-2 text-left">Invoice Status</th>
                                    <th class="px-2 py-2 text-left">Invoice Date</th>
                                    <th class="px-2 py-2 text-left no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Transaction</h2>
            <form id="transactionForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="transactionDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <input type="number" id="amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div id="currencyField" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                        <select id="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="USD">USD</option>
                            <option value="PKR">PKR</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                    <div id="merchantField" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Merchant</label>
                        <input type="text" id="merchant" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="purposeField" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label>
                        <input type="text" id="purpose" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- Invoice Fields (hidden for PKR) -->
                    <div id="invoiceFields">
                        <div class="col-span-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Number</label>
                                    <input type="text" id="invoiceNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <div id="invoiceNumberError" class="error-message" style="display: none;"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Link</label>
                                    <input type="url" id="invoiceLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <div id="invoiceLinkError" class="error-message" style="display: none;"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Status</label>
                                    <select id="invoiceStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Paid">Paid</option>
                                        <option value="Unpaid">Unpaid</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Date</label>
                                    <input type="date" id="invoiceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentTransactionType = null;
        let editingTransactionId = null;
        let transactions = {
            paypal: JSON.parse(localStorage.getItem('paypal_transactions') || '[]'),
            stripe: JSON.parse(localStorage.getItem('stripe_transactions') || '[]'),
            pkr: JSON.parse(localStorage.getItem('pkr_transactions') || '[]'),
            custom: JSON.parse(localStorage.getItem('custom_transactions') || '[]')
        };

        // Constants
        const EXCHANGE_RATE = 255; // Fixed PKR rate
        const FEE_RATE = 0.13; // 13% fee

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeLogin();
            initializeModals();
            initializeExport();
            loadSampleData();
        });

        // Load sample data if empty
        function loadSampleData() {
            if (transactions.paypal.length === 0) {
                transactions.paypal = [
                    {
                        id: 1,
                        date: '2024-01-15',
                        client: 'John Doe',
                        amount: 150.00,
                        netAmount: 130.50, // After 13% fee
                        pkrTotal: 33277.50, // netAmount * 255
                        invoiceNumber: 'INV-PAY-001',
                        invoiceLink: 'https://example.com/paypal-invoice1',
                        invoiceStatus: 'Paid',
                        invoiceDate: '2024-01-15'
                    }
                ];
            }
            
            if (transactions.stripe.length === 0) {
                transactions.stripe = [
                    {
                        id: 2,
                        date: '2024-01-16',
                        client: 'Jane Smith',
                        amount: 200.00,
                        netAmount: 174.00, // After 13% fee
                        pkrTotal: 44370.00, // netAmount * 255
                        invoiceNumber: 'INV-STR-001',
                        invoiceLink: 'https://example.com/stripe-invoice1',
                        invoiceStatus: 'Unpaid',
                        invoiceDate: '2024-01-16'
                    }
                ];
            }
            
            if (transactions.pkr.length === 0) {
                transactions.pkr = [
                    {
                        id: 3,
                        date: '2024-01-17',
                        client: 'Ahmad Ali',
                        amount: 25000,
                        purpose: 'Web Development'
                    }
                ];
            }
            
            if (transactions.custom.length === 0) {
                transactions.custom = [
                    {
                        id: 4,
                        date: '2024-01-18',
                        client: 'Custom Client',
                        amount: 100.00,
                        currency: 'EUR',
                        merchant: 'PayFast',
                        invoiceNumber: 'INV-CUS-001',
                        invoiceLink: 'https://example.com/custom-invoice1',
                        invoiceStatus: 'Paid',
                        invoiceDate: '2024-01-18'
                    }
                ];
            }
            
            saveToLocalStorage();
        }

        // Login system
        function initializeLogin() {
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if ((username === 'admin' && password === 'admin123') || 
                    (username === 'user' && password === 'user123')) {
                    currentUser = username;
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('userRole').textContent = username.charAt(0).toUpperCase() + username.slice(1);
                    
                    updateUIForRole();
                    loadDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('loginError').textContent = 'Invalid credentials';
                }
            });
            
            logoutBtn.addEventListener('click', function() {
                currentUser = null;
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginForm').reset();
                document.getElementById('loginError').style.display = 'none';
            });
        }

        // Update UI based on user role
        function updateUIForRole() {
            const isAdmin = currentUser === 'admin';
            const adminElements = document.querySelectorAll('#addPaypalBtn, #addStripeBtn, #addPkrBtn, #addCustomBtn, #exportBtn');
            
            adminElements.forEach(elem => {
                elem.style.display = isAdmin ? 'inline-block' : 'none';
            });
        }

        // Load dashboard data
        function loadDashboard() {
            updateBalances();
            updateTables();
            updateCharts();
        }

        // Update balance cards
        function updateBalances() {
            let totalUSD = 0;
            let totalPKRFromUSD = 0;
            let totalPKRSpent = 0;
            let totalTransactions = 0;
            
            // Calculate USD totals and PKR from USD
            transactions.paypal.forEach(t => {
                totalUSD += t.netAmount;
                totalPKRFromUSD += t.pkrTotal;
                totalTransactions++;
            });
            
            transactions.stripe.forEach(t => {
                totalUSD += t.netAmount;
                totalPKRFromUSD += t.pkrTotal;
                totalTransactions++;
            });
            
            // PKR transactions subtract from available balance
            transactions.pkr.forEach(t => {
                totalPKRSpent += t.amount;
                totalTransactions++;
            });
            
            transactions.custom.forEach(t => {
                if (t.currency === 'USD') {
                    totalUSD += t.amount;
                } else if (t.currency === 'PKR') {
                    totalPKRFromUSD += t.amount;
                }
                totalTransactions++;
            });
            
            const availablePKR = totalPKRFromUSD - totalPKRSpent;
            
            document.getElementById('pkrBalance').textContent = `${availablePKR.toLocaleString()} PKR`;
            document.getElementById('totalUSD').textContent = `$${totalUSD.toLocaleString()}`;
            document.getElementById('totalPKR').textContent = `${totalPKRFromUSD.toLocaleString()} PKR`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
        }

        // Update all tables
        function updateTables() {
            updatePaypalTable();
            updateStripeTable();
            updatePkrTable();
            updateCustomTable();
        }

        // Update PayPal table
        function updatePaypalTable() {
            const tbody = document.getElementById('paypalTable');
            tbody.innerHTML = '';
            
            transactions.paypal.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const statusBadge = transaction.invoiceStatus === 'Paid' ? 
                    '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Paid</span>' :
                    '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Unpaid</span>';
                
                const actionsHtml = currentUser === 'admin' ? 
                    `<button onclick="editTransaction('paypal', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTransaction('paypal', ${transaction.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>` : '-';
                
                row.innerHTML = `
                    <td class="px-2 py-2">${transaction.date}</td>
                    <td class="px-2 py-2">${transaction.client}</td>
                    <td class="px-2 py-2">$${transaction.amount.toFixed(2)}</td>
                    <td class="px-2 py-2">$${transaction.netAmount.toFixed(2)}</td>
                    <td class="px-2 py-2">${transaction.pkrTotal.toLocaleString()} PKR</td>
                    <td class="px-2 py-2">
                        <a href="${transaction.invoiceLink}" target="_blank" class="text-blue-600 hover:underline">
                            ${transaction.invoiceNumber}
                        </a>
                    </td>
                    <td class="px-2 py-2">${statusBadge}</td>
                    <td class="px-2 py-2">${transaction.invoiceDate}</td>
                    <td class="px-2 py-2 no-print">${actionsHtml}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Update Stripe table
        function updateStripeTable() {
            const tbody = document.getElementById('stripeTable');
            tbody.innerHTML = '';
            
            transactions.stripe.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const statusBadge = transaction.invoiceStatus === 'Paid' ? 
                    '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Paid</span>' :
                    '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Unpaid</span>';
                
                const actionsHtml = currentUser === 'admin' ? 
                    `<button onclick="editTransaction('stripe', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTransaction('stripe', ${transaction.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>` : '-';
                
                row.innerHTML = `
                    <td class="px-2 py-2">${transaction.date}</td>
                    <td class="px-2 py-2">${transaction.client}</td>
                    <td class="px-2 py-2">$${transaction.amount.toFixed(2)}</td>
                    <td class="px-2 py-2">$${transaction.netAmount.toFixed(2)}</td>
                    <td class="px-2 py-2">${transaction.pkrTotal.toLocaleString()} PKR</td>
                    <td class="px-2 py-2">
                        <a href="${transaction.invoiceLink}" target="_blank" class="text-blue-600 hover:underline">
                            ${transaction.invoiceNumber}
                        </a>
                    </td>
                    <td class="px-2 py-2">${statusBadge}</td>
                    <td class="px-2 py-2">${transaction.invoiceDate}</td>
                    <td class="px-2 py-2 no-print">${actionsHtml}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Update PKR table
        function updatePkrTable() {
            const tbody = document.getElementById('pkrTable');
            tbody.innerHTML = '';
            
            transactions.pkr.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const actionsHtml = currentUser === 'admin' ? 
                    `<button onclick="editTransaction('pkr', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTransaction('pkr', ${transaction.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>` : '-';
                
                row.innerHTML = `
                    <td class="px-2 py-2">${transaction.date}</td>
                    <td class="px-2 py-2">${transaction.client}</td>
                    <td class="px-2 py-2">${transaction.amount.toLocaleString()} PKR</td>
                    <td class="px-2 py-2">${transaction.purpose}</td>
                    <td class="px-2 py-2 no-print">${actionsHtml}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Update Custom table
        function updateCustomTable() {
            const tbody = document.getElementById('customTable');
            tbody.innerHTML = '';
            
            transactions.custom.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const statusBadge = transaction.invoiceStatus === 'Paid' ? 
                    '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Paid</span>' :
                    '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Unpaid</span>';
                
                const actionsHtml = currentUser === 'admin' ? 
                    `<button onclick="editTransaction('custom', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTransaction('custom', ${transaction.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>` : '-';
                
                row.innerHTML = `
                    <td class="px-2 py-2">${transaction.date}</td>
                    <td class="px-2 py-2">${transaction.client}</td>
                    <td class="px-2 py-2">${transaction.amount.toLocaleString()} ${transaction.currency}</td>
                    <td class="px-2 py-2">${transaction.currency}</td>
                    <td class="px-2 py-2">${transaction.merchant}</td>
                    <td class="px-2 py-2">
                        <a href="${transaction.invoiceLink}" target="_blank" class="text-blue-600 hover:underline">
                            ${transaction.invoiceNumber}
                        </a>
                    </td>
                    <td class="px-2 py-2">${statusBadge}</td>
                    <td class="px-2 py-2">${transaction.invoiceDate}</td>
                    <td class="px-2 py-2 no-print">${actionsHtml}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Initialize modal handlers
        function initializeModals() {
            const modal = document.getElementById('transactionModal');
            const closeBtn = document.querySelector('.close');
            const cancelBtn = document.getElementById('cancelBtn');
            const form = document.getElementById('transactionForm');
            
            document.getElementById('addPaypalBtn').addEventListener('click', () => openTransactionModal('paypal'));
            document.getElementById('addStripeBtn').addEventListener('click', () => openTransactionModal('stripe'));
            document.getElementById('addPkrBtn').addEventListener('click', () => openTransactionModal('pkr'));
            document.getElementById('addCustomBtn').addEventListener('click', () => openTransactionModal('custom'));
            
            closeBtn.addEventListener('click', closeTransactionModal);
            cancelBtn.addEventListener('click', closeTransactionModal);
            form.addEventListener('submit', handleTransactionSubmit);
            
            // Invoice validation
            document.getElementById('invoiceNumber').addEventListener('blur', validateInvoiceNumber);
            document.getElementById('invoiceLink').addEventListener('blur', validateInvoiceLink);
        }

        // Open transaction modal
        function openTransactionModal(type) {
            currentTransactionType = type;
            editingTransactionId = null;
            
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            
            title.textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)} Transaction`;
            
            // Show/hide fields based on type
            const currencyField = document.getElementById('currencyField');
            const merchantField = document.getElementById('merchantField');
            const purposeField = document.getElementById('purposeField');
            const invoiceFields = document.getElementById('invoiceFields');
            
            currencyField.style.display = type === 'custom' ? 'block' : 'none';
            merchantField.style.display = type === 'custom' ? 'block' : 'none';
            purposeField.style.display = type === 'pkr' ? 'block' : 'none';
            invoiceFields.style.display = type === 'pkr' ? 'none' : 'block';
            
            // Set required fields
            const invoiceNumber = document.getElementById('invoiceNumber');
            const invoiceLink = document.getElementById('invoiceLink');
            const invoiceStatus = document.getElementById('invoiceStatus');
            const invoiceDate = document.getElementById('invoiceDate');
            
            if (type === 'pkr') {
                invoiceNumber.required = false;
                invoiceLink.required = false;
                invoiceStatus.required = false;
                invoiceDate.required = false;
            } else {
                invoiceNumber.required = true;
                invoiceLink.required = true;
                invoiceStatus.required = true;
                invoiceDate.required = true;
            }
            
            document.getElementById('transactionForm').reset();
            clearValidationErrors();
            modal.style.display = 'block';
        }

        // Close transaction modal
        function closeTransactionModal() {
            document.getElementById('transactionModal').style.display = 'none';
            currentTransactionType = null;
            editingTransactionId = null;
        }

        // Handle transaction form submission
        function handleTransactionSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const formData = getFormData();
            
            if (editingTransactionId) {
                updateTransaction(formData);
            } else {
                addTransaction(formData);
            }
            
            closeTransactionModal();
            saveToLocalStorage();
            loadDashboard();
        }

        // Get form data
        function getFormData() {
            const data = {
                date: document.getElementById('transactionDate').value,
                client: document.getElementById('clientName').value,
                amount: parseFloat(document.getElementById('amount').value)
            };
            
            if (currentTransactionType !== 'pkr') {
                data.invoiceNumber = document.getElementById('invoiceNumber').value;
                data.invoiceLink = document.getElementById('invoiceLink').value;
                data.invoiceStatus = document.getElementById('invoiceStatus').value;
                data.invoiceDate = document.getElementById('invoiceDate').value;
            }
            
            if (currentTransactionType === 'custom') {
                data.currency = document.getElementById('currency').value;
                data.merchant = document.getElementById('merchant').value;
            }
            
            if (currentTransactionType === 'pkr') {
                data.purpose = document.getElementById('purpose').value;
            }
            
            // Calculate derived values
            if (currentTransactionType === 'paypal' || currentTransactionType === 'stripe') {
                data.netAmount = data.amount * (1 - FEE_RATE); // Apply 13% fee
                data.pkrTotal = data.netAmount * EXCHANGE_RATE; // Convert to PKR
            }
            
            return data;
        }

        // Add transaction
        function addTransaction(data) {
            const id = Date.now();
            transactions[currentTransactionType].push({ id, ...data });
        }

        // Update transaction
        function updateTransaction(data) {
            const index = transactions[currentTransactionType].findIndex(t => t.id === editingTransactionId);
            if (index !== -1) {
                transactions[currentTransactionType][index] = { id: editingTransactionId, ...data };
            }
        }

        // Edit transaction
        function editTransaction(type, id) {
            const transaction = transactions[type].find(t => t.id === id);
            if (!transaction) return;
            
            currentTransactionType = type;
            editingTransactionId = id;
            
            // Fill form with transaction data
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('clientName').value = transaction.client;
            document.getElementById('amount').value = transaction.amount;
            
            if (type !== 'pkr') {
                document.getElementById('invoiceNumber').value = transaction.invoiceNumber || '';
                document.getElementById('invoiceLink').value = transaction.invoiceLink || '';
                document.getElementById('invoiceStatus').value = transaction.invoiceStatus || 'Paid';
                document.getElementById('invoiceDate').value = transaction.invoiceDate || '';
            }
            
            if (type === 'custom') {
                document.getElementById('currency').value = transaction.currency || 'USD';
                document.getElementById('merchant').value = transaction.merchant || '';
            }
            
            if (type === 'pkr') {
                document.getElementById('purpose').value = transaction.purpose || '';
            }
            
            openTransactionModal(type);
            document.getElementById('modalTitle').textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)} Transaction`;
        }

        // Delete transaction
        function deleteTransaction(type, id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions[type] = transactions[type].filter(t => t.id !== id);
                saveToLocalStorage();
                loadDashboard();
            }
        }

        // Validate form
        function validateForm() {
            if (currentTransactionType === 'pkr') {
                return true; // PKR doesn't need invoice validation
            }
            
            let isValid = true;
            
            if (!validateInvoiceNumber()) {
                isValid = false;
            }
            
            if (!validateInvoiceLink()) {
                isValid = false;
            }
            
            return isValid;
        }

        // Validate invoice number uniqueness
        function validateInvoiceNumber() {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const errorElement = document.getElementById('invoiceNumberError');
            
            if (!invoiceNumber.trim()) {
                errorElement.style.display = 'none';
                return true;
            }
            
            const allTransactions = [
                ...transactions.paypal,
                ...transactions.stripe,
                ...transactions.custom
            ];
            
            const duplicate = allTransactions.find(t => 
                t.invoiceNumber === invoiceNumber && 
                t.id !== editingTransactionId
            );
            
            if (duplicate) {
                errorElement.textContent = 'Invoice number already exists';
                errorElement.style.display = 'block';
                return false;
            }
            
            errorElement.style.display = 'none';
            return true;
        }

        // Validate invoice link uniqueness
        function validateInvoiceLink() {
            const invoiceLink = document.getElementById('invoiceLink').value;
            const errorElement = document.getElementById('invoiceLinkError');
            
            if (!invoiceLink.trim()) {
                errorElement.style.display = 'none';
                return true;
            }
            
            const allTransactions = [
                ...transactions.paypal,
                ...transactions.stripe,
                ...transactions.custom
            ];
            
            const duplicate = allTransactions.find(t => 
                t.invoiceLink === invoiceLink && 
                t.id !== editingTransactionId
            );
            
            if (duplicate) {
                errorElement.textContent = 'Invoice link already exists';
                errorElement.style.display = 'block';
                return false;
            }
            
            errorElement.style.display = 'none';
            return true;
        }

        // Clear validation errors
        function clearValidationErrors() {
            document.getElementById('invoiceNumberError').style.display = 'none';
            document.getElementById('invoiceLinkError').style.display = 'none';
        }

        // Initialize export functionality
        function initializeExport() {
            document.getElementById('exportBtn').addEventListener('click', exportAllData);
        }

        // Export all data to Excel
        function exportAllData() {
            const wb = XLSX.utils.book_new();
            
            // PayPal sheet
            const paypalData = transactions.paypal.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                Amount: t.amount,
                'Net Amount': t.netAmount,
                'PKR Total': t.pkrTotal,
                'Invoice Number': t.invoiceNumber,
                'Invoice Link': t.invoiceLink,
                'Invoice Status': t.invoiceStatus,
                'Invoice Date': t.invoiceDate
            }));
            const paypalWS = XLSX.utils.json_to_sheet(paypalData);
            XLSX.utils.book_append_sheet(wb, paypalWS, 'PayPal');
            
            // Stripe sheet
            const stripeData = transactions.stripe.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                Amount: t.amount,
                'Net Amount': t.netAmount,
                'PKR Total': t.pkrTotal,
                'Invoice Number': t.invoiceNumber,
                'Invoice Link': t.invoiceLink,
                'Invoice Status': t.invoiceStatus,
                'Invoice Date': t.invoiceDate
            }));
            const stripeWS = XLSX.utils.json_to_sheet(stripeData);
            XLSX.utils.book_append_sheet(wb, stripeWS, 'Stripe');
            
            // PKR sheet
            const pkrData = transactions.pkr.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                'PKR Amount': t.amount,
                Purpose: t.purpose
            }));
            const pkrWS = XLSX.utils.json_to_sheet(pkrData);
            XLSX.utils.book_append_sheet(wb, pkrWS, 'PKR');
            
            // Custom sheet
            const customData = transactions.custom.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                Amount: t.amount,
                Currency: t.currency,
                Merchant: t.merchant,
                'Invoice Number': t.invoiceNumber,
                'Invoice Link': t.invoiceLink,
                'Invoice Status': t.invoiceStatus,
                'Invoice Date': t.invoiceDate
            }));
            const customWS = XLSX.utils.json_to_sheet(customData);
            XLSX.utils.book_append_sheet(wb, customWS, 'Custom');
            
            // Save the file
            XLSX.writeFile(wb, 'payment_dashboard_export.xlsx');
        }

        // Update charts
        function updateCharts() {
            updateRevenueChart();
            updateDistributionChart();
        }

        // Update revenue chart
        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Sample data for demonstration
            const monthlyData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Revenue (USD)',
                    data: [1200, 1900, 3000, 5000, 2000, 3000],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: monthlyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update distribution chart
        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            const distributionData = {
                labels: ['PayPal', 'Stripe', 'PKR', 'Custom'],
                datasets: [{
                    data: [
                        transactions.paypal.length,
                        transactions.stripe.length,
                        transactions.pkr.length,
                        transactions.custom.length
                    ],
                    backgroundColor: [
                        '#3B82F6',
                        '#10B981',
                        '#8B5CF6',
                        '#F59E0B'
                    ]
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: distributionData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('paypal_transactions', JSON.stringify(transactions.paypal));
            localStorage.setItem('stripe_transactions', JSON.stringify(transactions.stripe));
            localStorage.setItem('pkr_transactions', JSON.stringify(transactions.pkr));
            localStorage.setItem('custom_transactions', JSON.stringify(transactions.custom));
        }
    </script>
</body>
</html>
