<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced PayPal & Multi-Payment Transaction Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .table-hover tbody tr:hover {
            background-color: #f8fafc;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        .btn-stripe {
            background: linear-gradient(45deg, #635bff, #4f46e5);
        }
        .btn-merchant {
            background: linear-gradient(45deg, #06b6d4, #0891b2);
        }
        .photo-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        .photo-modal {
            backdrop-filter: blur(10px);
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-tabs {
            border-bottom: 2px solid #e5e7eb;
        }
        .nav-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .nav-tab.active {
            color: #4f46e5;
        }
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
        }
        .balance-indicator {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 12px;
            text-align: center;
            margin: 8px 0;
        }
        .balance-positive {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }
        .balance-negative {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }
        .balance-zero {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Admin Login</h2>
                <p class="text-gray-600 mt-2">Please enter your credentials</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter username">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter password">
                </div>
                <button type="submit" class="w-full btn-primary text-white py-3 px-4 rounded-lg font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </form>
            <div class="mt-4 text-center">
                <button id="guestLoginBtn" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-eye mr-1"></i>Continue as Guest (Read-only)
                </button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden photo-modal">
        <div class="max-w-4xl max-h-screen p-4">
            <div class="relative">
                <button id="closePhotoModal" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-70">
                    <i class="fas fa-times"></i>
                </button>
                <img id="modalPhoto" src="" alt="Transaction Photo" class="max-w-full max-h-screen object-contain rounded-lg">
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold">Multi-Payment Dashboard</h1>
                            <p class="text-blue-100">PayPal, Stripe, PKR & Custom Merchant Management</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm text-blue-100">Welcome back</p>
                            <p class="font-semibold" id="userRole">Admin</p>
                        </div>
                        <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- PKR Balance Display -->
        <div class="container mx-auto px-4 py-4">
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-wallet text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">PKR Balance</h3>
                            <p class="text-sm text-gray-600">Current available balance</p>
                        </div>
                    </div>
                    <div class="balance-indicator" id="pkrBalance">0 PKR</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 pb-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total USD</p>
                            <p class="text-2xl font-bold text-green-600" id="totalUSD">$0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total PKR</p>
                            <p class="text-2xl font-bold text-blue-600" id="totalPKR">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-rupee-sign text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Transactions</p>
                            <p class="text-2xl font-bold text-purple-600" id="totalTransactions">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h3 class="text-lg font-semibold mb-4">Monthly Revenue Trend</h3>
                    <div style="height: 300px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h3 class="text-lg font-semibold mb-4">Payment Methods Distribution</h3>
                    <div style="height: 300px;">
                        <canvas id="paymentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white rounded-xl card-shadow">
                <div class="nav-tabs">
                    <div class="flex space-x-0">
                        <button class="nav-tab active" data-tab="paypal">
                            <i class="fab fa-paypal mr-2"></i>PayPal
                        </button>
                        <button class="nav-tab" data-tab="stripe">
                            <i class="fab fa-stripe mr-2"></i>Stripe
                        </button>
                        <button class="nav-tab" data-tab="pkr">
                            <i class="fas fa-rupee-sign mr-2"></i>PKR
                        </button>
                        <button class="nav-tab" data-tab="merchants">
                            <i class="fas fa-store mr-2"></i>Custom Merchants
                        </button>
                    </div>
                </div>

                <!-- PayPal Section -->
                <div id="paypal-section" class="tab-content">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <i class="fab fa-paypal text-blue-600 mr-2"></i>PayPal USD Transactions
                            </h2>
                            <button id="exportPayPalBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-file-excel mr-2"></i>Export PayPal
                            </button>
                        </div>
                        
                        <!-- PayPal Form -->
                        <div id="paypalForm" class="bg-gray-50 p-6 rounded-lg mb-6">
                            <form id="paypalTransactionForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                                        <input type="text" id="paypalClientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">USD Amount</label>
                                        <input type="number" id="paypalAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Exchange Rate</label>
                                        <input type="number" id="paypalExchangeRate" value="255" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo</label>
                                        <input type="file" id="paypalPhoto" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Net Amount</label>
                                        <input type="number" id="paypalNetAmount" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Total PKR</label>
                                        <input type="number" id="paypalTotalPKR" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add PayPal Transaction
                                </button>
                            </form>
                        </div>

                        <!-- PayPal Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full table-hover">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PKR Total</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paypalTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stripe Section -->
                <div id="stripe-section" class="tab-content hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <i class="fab fa-stripe text-purple-600 mr-2"></i>Stripe USD Transactions
                            </h2>
                            <button id="exportStripeBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-file-excel mr-2"></i>Export Stripe
                            </button>
                        </div>
                        
                        <!-- Stripe Form -->
                        <div id="stripeForm" class="bg-gray-50 p-6 rounded-lg mb-6">
                            <form id="stripeTransactionForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                                        <input type="text" id="stripeClientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">USD Amount</label>
                                        <input type="number" id="stripeAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Exchange Rate</label>
                                        <input type="number" id="stripeExchangeRate" value="255" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo</label>
                                        <input type="file" id="stripePhoto" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Net Amount</label>
                                        <input type="number" id="stripeNetAmount" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Total PKR</label>
                                        <input type="number" id="stripeTotalPKR" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                </div>
                                <button type="submit" class="btn-stripe text-white px-6 py-2 rounded-lg font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Stripe Transaction
                                </button>
                            </form>
                        </div>

                        <!-- Stripe Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full table-hover">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PKR Total</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stripeTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PKR Section -->
                <div id="pkr-section" class="tab-content hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-rupee-sign text-green-600 mr-2"></i>PKR Transactions
                            </h2>
                            <button id="exportPKRBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-file-excel mr-2"></i>Export PKR
                            </button>
                        </div>
                        
                        <!-- PKR Form -->
                        <div id="pkrForm" class="bg-gray-50 p-6 rounded-lg mb-6">
                            <form id="pkrTransactionForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                                        <input type="text" id="pkrClientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">PKR Amount</label>
                                        <input type="number" id="pkrAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Purpose/Note</label>
                                        <input type="text" id="pkrPurpose" placeholder="e.g., Cash received, Mobile top-up" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo</label>
                                        <input type="file" id="pkrPhoto" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    </div>
                                </div>
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add PKR Transaction
                                </button>
                            </form>
                        </div>

                        <!-- PKR Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full table-hover">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PKR Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purpose</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pkrTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Custom Merchants Section -->
                <div id="merchants-section" class="tab-content hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-store text-cyan-600 mr-2"></i>Custom Merchants
                            </h2>
                            <div class="flex space-x-2">
                                <button id="addMerchantBtn" class="btn-merchant text-white px-4 py-2 rounded-lg font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Merchant
                                </button>
                                <button id="exportMerchantsBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                                    <i class="fas fa-file-excel mr-2"></i>Export All
                                </button>
                            </div>
                        </div>

                        <!-- Add Merchant Form -->
                        <div id="addMerchantForm" class="bg-gray-50 p-6 rounded-lg mb-6 hidden">
                            <form id="newMerchantForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Merchant Name</label>
                                        <input type="text" id="newMerchantName" placeholder="e.g., Binance, Coinbase" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Merchant Icon (Font Awesome class)</label>
                                        <input type="text" id="newMerchantIcon" placeholder="e.g., fab fa-bitcoin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button type="submit" class="btn-merchant text-white px-6 py-2 rounded-lg font-semibold">
                                        <i class="fas fa-plus mr-2"></i>Create Merchant
                                    </button>
                                    <button type="button" id="cancelMerchantBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Merchants List -->
                        <div id="merchantsList" class="space-y-6">
                            <!-- Dynamic merchant sections will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Edit Transaction</h3>
            <form id="editForm">
                <div id="editFormFields">
                    <!-- Dynamic form fields will be populated here -->
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="cancelEdit" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Application state
        let isAdmin = false;
        let currentUser = '';
        let paypalTransactions = JSON.parse(localStorage.getItem('paypalTransactions')) || [];
        let stripeTransactions = JSON.parse(localStorage.getItem('stripeTransactions')) || [];
        let pkrTransactions = JSON.parse(localStorage.getItem('pkrTransactions')) || [];
        let customMerchants = JSON.parse(localStorage.getItem('customMerchants')) || [];
        let merchantTransactions = JSON.parse(localStorage.getItem('merchantTransactions')) || {};
        let pkrBalance = parseFloat(localStorage.getItem('pkrBalance')) || 0;
        let editingTransaction = null;
        let revenueChart = null;
        let paymentChart = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                isAdmin = userData.isAdmin;
                currentUser = userData.username;
                showDashboard();
            }

            setupEventListeners();
            setupTabNavigation();
            initializeCharts();
        });

        // Event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('guestLoginBtn').addEventListener('click', handleGuestLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Transaction forms
            document.getElementById('paypalTransactionForm').addEventListener('submit', handlePayPalTransaction);
            document.getElementById('stripeTransactionForm').addEventListener('submit', handleStripeTransaction);
            document.getElementById('pkrTransactionForm').addEventListener('submit', handlePKRTransaction);

            // Auto-calculate fees and totals
            document.getElementById('paypalAmount').addEventListener('input', () => calculateFees('paypal'));
            document.getElementById('paypalExchangeRate').addEventListener('input', () => calculateFees('paypal'));
            document.getElementById('stripeAmount').addEventListener('input', () => calculateFees('stripe'));
            document.getElementById('stripeExchangeRate').addEventListener('input', () => calculateFees('stripe'));

            // Custom merchants
            document.getElementById('addMerchantBtn').addEventListener('click', showAddMerchantForm);
            document.getElementById('cancelMerchantBtn').addEventListener('click', hideAddMerchantForm);
            document.getElementById('newMerchantForm').addEventListener('submit', handleAddMerchant);

            // Export buttons
            document.getElementById('exportPayPalBtn').addEventListener('click', () => exportToExcel('paypal'));
            document.getElementById('exportStripeBtn').addEventListener('click', () => exportToExcel('stripe'));
            document.getElementById('exportPKRBtn').addEventListener('click', () => exportToExcel('pkr'));
            document.getElementById('exportMerchantsBtn').addEventListener('click', () => exportToExcel('merchants'));

            // Edit modal
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);

            // Photo modal
            document.getElementById('closePhotoModal').addEventListener('click', closePhotoModal);
        }

        // Tab navigation
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    // Show target tab content
                    document.getElementById(targetTab + '-section').classList.remove('hidden');
                });
            });
        }

        // Login handling
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'admin123') {
                isAdmin = true;
                currentUser = 'admin';
                localStorage.setItem('currentUser', JSON.stringify({ username: 'admin', isAdmin: true }));
                showDashboard();
            } else {
                alert('Invalid credentials! Use: admin/admin123');
            }
        }

        function handleGuestLogin() {
            isAdmin = false;
            currentUser = 'guest';
            localStorage.setItem('currentUser', JSON.stringify({ username: 'guest', isAdmin: false }));
            showDashboard();
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            isAdmin = false;
            currentUser = '';
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userRole').textContent = isAdmin ? 'Admin' : 'Guest (Read-only)';
            
            // Show/hide admin-only elements
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = isAdmin ? 'table-cell' : 'none';
            });

            const forms = document.querySelectorAll('#paypalForm, #stripeForm, #pkrForm, #addMerchantForm');
            forms.forEach(form => {
                form.style.display = isAdmin ? 'block' : 'none';
            });

            document.getElementById('addMerchantBtn').style.display = isAdmin ? 'block' : 'none';

            renderAllTransactions();
            updateStats();
            updatePKRBalance();
            renderCustomMerchants();
            updateCharts();
        }

        // Fee calculation (hidden from UI but used for calculations)
        function calculateFees(type) {
            const amountInput = document.getElementById(type + 'Amount');
            const exchangeRateInput = document.getElementById(type + 'ExchangeRate');
            const netAmountInput = document.getElementById(type + 'NetAmount');
            const totalPKRInput = document.getElementById(type + 'TotalPKR');

            const amount = parseFloat(amountInput.value) || 0;
            const exchangeRate = parseFloat(exchangeRateInput.value) || 0;
            const fee = amount * 0.13; // 13% fee - calculated but not displayed
            const netAmount = amount - fee;
            const totalPKR = netAmount * exchangeRate;

            netAmountInput.value = netAmount.toFixed(2);
            totalPKRInput.value = totalPKR.toFixed(2);
        }

        // Photo handling
        function handlePhotoUpload(file) {
            return new Promise((resolve) => {
                if (!file) {
                    resolve(null);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Simulate generating a public URL
                    const publicUrl = `https://example.com/photos/${Date.now()}_${file.name}`;
                    resolve({
                        url: publicUrl,
                        data: e.target.result // Base64 data for preview
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function showPhotoModal(photoData) {
            if (!photoData) return;
            
            document.getElementById('modalPhoto').src = photoData.data || photoData.url;
            document.getElementById('photoModal').classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        // Transaction handling
        async function handlePayPalTransaction(e) {
            e.preventDefault();
            if (!isAdmin) return;

            const photoFile = document.getElementById('paypalPhoto').files[0];
            const photoData = await handlePhotoUpload(photoFile);

            const amount = parseFloat(document.getElementById('paypalAmount').value);
            const exchangeRate = parseFloat(document.getElementById('paypalExchangeRate').value);
            const fee = amount * 0.13; // Hidden calculation
            const netAmount = amount - fee;
            const totalPKR = netAmount * exchangeRate;

            const transaction = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                clientName: document.getElementById('paypalClientName').value,
                amount: amount,
                fee: fee, // Stored but not displayed
                netAmount: netAmount,
                exchangeRate: exchangeRate,
                totalPKR: totalPKR,
                photo: photoData
            };

            paypalTransactions.push(transaction);
            pkrBalance += totalPKR;
            
            localStorage.setItem('paypalTransactions', JSON.stringify(paypalTransactions));
            localStorage.setItem('pkrBalance', pkrBalance.toString());
            
            document.getElementById('paypalTransactionForm').reset();
            document.getElementById('paypalExchangeRate').value = '255';
            
            renderAllTransactions();
            updateStats();
            updatePKRBalance();
            updateCharts();
        }

        async function handleStripeTransaction(e) {
            e.preventDefault();
            if (!isAdmin) return;

            const photoFile = document.getElementById('stripePhoto').files[0];
            const photoData = await handlePhotoUpload(photoFile);

            const amount = parseFloat(document.getElementById('stripeAmount').value);
            const exchangeRate = parseFloat(document.getElementById('stripeExchangeRate').value);
            const fee = amount * 0.13; // Hidden calculation
            const netAmount = amount - fee;
            const totalPKR = netAmount * exchangeRate;

            const transaction = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                clientName: document.getElementById('stripeClientName').value,
                amount: amount,
                fee: fee, // Stored but not displayed
                netAmount: netAmount,
                exchangeRate: exchangeRate,
                totalPKR: totalPKR,
                photo: photoData
            };

            stripeTransactions.push(transaction);
            pkrBalance += totalPKR;
            
            localStorage.setItem('stripeTransactions', JSON.stringify(stripeTransactions));
            localStorage.setItem('pkrBalance', pkrBalance.toString());
            
            document.getElementById('stripeTransactionForm').reset();
            document.getElementById('stripeExchangeRate').value = '255';
            
            renderAllTransactions();
            updateStats();
            updatePKRBalance();
            updateCharts();
        }

        async function handlePKRTransaction(e) {
            e.preventDefault();
            if (!isAdmin) return;

            const photoFile = document.getElementById('pkrPhoto').files[0];
            const photoData = await handlePhotoUpload(photoFile);
            const amount = parseFloat(document.getElementById('pkrAmount').value);

            if (amount > pkrBalance) {
                alert('Insufficient PKR balance!');
                return;
            }

            const transaction = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                clientName: document.getElementById('pkrClientName').value,
                amount: amount,
                purpose: document.getElementById('pkrPurpose').value || 'N/A',
                photo: photoData
            };

            pkrTransactions.push(transaction);
            pkrBalance -= amount; // Deduct from PKR balance
            
            localStorage.setItem('pkrTransactions', JSON.stringify(pkrTransactions));
            localStorage.setItem('pkrBalance', pkrBalance.toString());
            
            document.getElementById('pkrTransactionForm').reset();
            
            renderAllTransactions();
            updateStats();
            updatePKRBalance();
            updateCharts();
        }

        // Custom merchants
        function showAddMerchantForm() {
            document.getElementById('addMerchantForm').classList.remove('hidden');
        }

        function hideAddMerchantForm() {
            document.getElementById('addMerchantForm').classList.add('hidden');
            document.getElementById('newMerchantForm').reset();
        }

        function handleAddMerchant(e) {
            e.preventDefault();
            if (!isAdmin) return;

            const merchantName = document.getElementById('newMerchantName').value;
            const merchantIcon = document.getElementById('newMerchantIcon').value || 'fas fa-store';

            const merchant = {
                id: Date.now(),
                name: merchantName,
                icon: merchantIcon,
                transactions: []
            };

            customMerchants.push(merchant);
            merchantTransactions[merchant.id] = [];
            
            localStorage.setItem('customMerchants', JSON.stringify(customMerchants));
            localStorage.setItem('merchantTransactions', JSON.stringify(merchantTransactions));
            
            hideAddMerchantForm();
            renderCustomMerchants();
        }

        function renderCustomMerchants() {
            const merchantsList = document.getElementById('merchantsList');
            merchantsList.innerHTML = '';

            customMerchants.forEach(merchant => {
                const merchantSection = document.createElement('div');
                merchantSection.className = 'bg-white p-6 rounded-xl card-shadow';
                merchantSection.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">
                            <i class="${merchant.icon} text-cyan-600 mr-2"></i>${merchant.name}
                        </h3>
                        <button onclick="deleteMerchant(${merchant.id})" class="text-red-600 hover:text-red-800 admin-only" style="display: ${isAdmin ? 'block' : 'none'}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mb-4 admin-only" style="display: ${isAdmin ? 'block' : 'none'}">
                        <form onsubmit="handleMerchantTransaction(event, ${merchant.id})">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                                    <input type="text" id="merchant${merchant.id}ClientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">USD Amount</label>
                                    <input type="number" id="merchant${merchant.id}Amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required onchange="calculateMerchantFees(${merchant.id})">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Exchange Rate</label>
                                    <input type="number" id="merchant${merchant.id}ExchangeRate" value="255" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required onchange="calculateMerchantFees(${merchant.id})">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Photo</label>
                                    <input type="file" id="merchant${merchant.id}Photo" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Net Amount</label>
                                    <input type="number" id="merchant${merchant.id}NetAmount" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total PKR</label>
                                    <input type="number" id="merchant${merchant.id}TotalPKR" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                </div>
                            </div>
                            <button type="submit" class="btn-merchant text-white px-6 py-2 rounded-lg font-semibold">
                                <i class="fas fa-plus mr-2"></i>Add ${merchant.name} Transaction
                            </button>
                        </form>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full table-hover">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PKR Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'}">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="merchant${merchant.id}TableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                `;
                merchantsList.appendChild(merchantSection);
                
                // Render merchant transactions
                renderMerchantTransactions(merchant.id);
            });
        }

        function calculateMerchantFees(merchantId) {
            const amount = parseFloat(document.getElementById(`merchant${merchantId}Amount`).value) || 0;
            const exchangeRate = parseFloat(document.getElementById(`merchant${merchantId}ExchangeRate`).value) || 0;
            const fee = amount * 0.13; // Hidden calculation
            const netAmount = amount - fee;
            const totalPKR = netAmount * exchangeRate;

            document.getElementById(`merchant${merchantId}NetAmount`).value = netAmount.toFixed(2);
            document.getElementById(`merchant${merchantId}TotalPKR`).value = totalPKR.toFixed(2);
        }

        async function handleMerchantTransaction(e, merchantId) {
            e.preventDefault();
            if (!isAdmin) return;

            const photoFile = document.getElementById(`merchant${merchantId}Photo`).files[0];
            const photoData = await handlePhotoUpload(photoFile);

            const amount = parseFloat(document.getElementById(`merchant${merchantId}Amount`).value);
            const exchangeRate = parseFloat(document.getElementById(`merchant${merchantId}ExchangeRate`).value);
            const fee = amount * 0.13; // Hidden calculation
            const netAmount = amount - fee;
            const totalPKR = netAmount * exchangeRate;

            const transaction = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                clientName: document.getElementById(`merchant${merchantId}ClientName`).value,
                amount: amount,
                fee: fee, // Stored but not displayed
                netAmount: netAmount,
                exchangeRate: exchangeRate,
                totalPKR: totalPKR,
                photo: photoData
            };

            if (!merchantTransactions[merchantId]) {
                merchantTransactions[merchantId] = [];
            }
            merchantTransactions[merchantId].push(transaction);
            pkrBalance += totalPKR;
            
            localStorage.setItem('merchantTransactions', JSON.stringify(merchantTransactions));
            localStorage.setItem('pkrBalance', pkrBalance.toString());
            
            // Reset form
            document.getElementById(`merchant${merchantId}ClientName`).value = '';
            document.getElementById(`merchant${merchantId}Amount`).value = '';
            document.getElementById(`merchant${merchantId}ExchangeRate`).value = '255';
            document.getElementById(`merchant${merchantId}Photo`).value = '';
            document.getElementById(`merchant${merchantId}NetAmount`).value = '';
            document.getElementById(`merchant${merchantId}TotalPKR`).value = '';
            
            renderMerchantTransactions(merchantId);
            updateStats();
            updatePKRBalance();
            updateCharts();
        }

        function renderMerchantTransactions(merchantId) {
            const tbody = document.getElementById(`merchant${merchantId}TableBody`);
            if (!tbody) return;

            tbody.innerHTML = '';
            const transactions = merchantTransactions[merchantId] || [];

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.date}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${transaction.photo ? `<img src="${transaction.photo.data || transaction.photo.url}" alt="Photo" class="photo-preview" onclick="showPhotoModal(${JSON.stringify(transaction.photo).replace(/"/g, '&quot;')})">` : 'No photo'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.clientName}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">$${transaction.amount.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-green-600">$${transaction.netAmount.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.totalPKR.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                        <button onclick="deleteMerchantTransaction(${merchantId}, ${transaction.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteMerchant(merchantId) {
            if (!isAdmin) return;
            
            if (confirm('Are you sure you want to delete this merchant and all its transactions?')) {
                customMerchants = customMerchants.filter(m => m.id !== merchantId);
                delete merchantTransactions[merchantId];
                
                localStorage.setItem('customMerchants', JSON.stringify(customMerchants));
                localStorage.setItem('merchantTransactions', JSON.stringify(merchantTransactions));
                
                renderCustomMerchants();
                updateStats();
                updateCharts();
            }
        }

        function deleteMerchantTransaction(merchantId, transactionId) {
            if (!isAdmin) return;
            
            if (confirm('Are you sure you want to delete this transaction?')) {
                const transaction = merchantTransactions[merchantId].find(t => t.id === transactionId);
                if (transaction) {
                    pkrBalance -= transaction.totalPKR;
                    localStorage.setItem('pkrBalance', pkrBalance.toString());
                }
                
                merchantTransactions[merchantId] = merchantTransactions[merchantId].filter(t => t.id !== transactionId);
                localStorage.setItem('merchantTransactions', JSON.stringify(merchantTransactions));
                
                renderMerchantTransactions(merchantId);
                updateStats();
                updatePKRBalance();
                updateCharts();
            }
        }

        // Render all transactions
        function renderAllTransactions() {
            renderPayPalTransactions();
            renderStripeTransactions();
            renderPKRTransactions();
            renderCustomMerchants();
        }

        function renderPayPalTransactions() {
            const tbody = document.getElementById('paypalTableBody');
            tbody.innerHTML = '';

            paypalTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.date}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${transaction.photo ? `<img src="${transaction.photo.data || transaction.photo.url}" alt="Photo" class="photo-preview" onclick="showPhotoModal(${JSON.stringify(transaction.photo).replace(/"/g, '&quot;')})">` : 'No photo'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.clientName}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">$${transaction.amount.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-green-600">$${transaction.netAmount.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.totalPKR.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                        <button onclick="deleteTransaction('paypal', ${transaction.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderStripeTransactions() {
            const tbody = document.getElementById('stripeTableBody');
            tbody.innerHTML = '';

            stripeTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.date}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${transaction.photo ? `<img src="${transaction.photo.data || transaction.photo.url}" alt="Photo" class="photo-preview" onclick="showPhotoModal(${JSON.stringify(transaction.photo).replace(/"/g, '&quot;')})">` : 'No photo'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.clientName}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">$${transaction.amount.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-green-600">$${transaction.netAmount.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.totalPKR.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                        <button onclick="deleteTransaction('stripe', ${transaction.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderPKRTransactions() {
            const tbody = document.getElementById('pkrTableBody');
            tbody.innerHTML = '';

            pkrTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.date}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${transaction.photo ? `<img src="${transaction.photo.data || transaction.photo.url}" alt="Photo" class="photo-preview" onclick="showPhotoModal(${JSON.stringify(transaction.photo).replace(/"/g, '&quot;')})">` : 'No photo'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.clientName}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-red-600">-${transaction.amount.toFixed(2)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.purpose}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 admin-only" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                        <button onclick="deleteTransaction('pkr', ${transaction.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Delete transactions
        function deleteTransaction(type, id) {
            if (!isAdmin) return;
            
            if (confirm('Are you sure you want to delete this transaction?')) {
                if (type === 'paypal') {
                    const transaction = paypalTransactions.find(t => t.id === id);
                    if (transaction) {
                        pkrBalance -= transaction.totalPKR;
                    }
                    paypalTransactions = paypalTransactions.filter(t => t.id !== id);
                    localStorage.setItem('paypalTransactions', JSON.stringify(paypalTransactions));
                } else if (type === 'stripe') {
                    const transaction = stripeTransactions.find(t => t.id === id);
                    if (transaction) {
                        pkrBalance -= transaction.totalPKR;
                    }
                    stripeTransactions = stripeTransactions.filter(t => t.id !== id);
                    localStorage.setItem('stripeTransactions', JSON.stringify(stripeTransactions));
                } else if (type === 'pkr') {
                    const transaction = pkrTransactions.find(t => t.id === id);
                    if (transaction) {
                        pkrBalance += transaction.amount; // Add back since it was deducted
                    }
                    pkrTransactions = pkrTransactions.filter(t => t.id !== id);
                    localStorage.setItem('pkrTransactions', JSON.stringify(pkrTransactions));
                }
                
                localStorage.setItem('pkrBalance', pkrBalance.toString());
                renderAllTransactions();
                updateStats();
                updatePKRBalance();
                updateCharts();
            }
        }

        // Update PKR balance display
        function updatePKRBalance() {
            const balanceEl = document.getElementById('pkrBalance');
            balanceEl.textContent = `${pkrBalance.toFixed(2)} PKR`;
            
            // Update balance indicator styling
            balanceEl.className = 'balance-indicator ';
            if (pkrBalance > 0) {
                balanceEl.className += 'balance-positive';
            } else if (pkrBalance < 0) {
                balanceEl.className += 'balance-negative';
            } else {
                balanceEl.className += 'balance-zero';
            }
        }

        // Update statistics
        function updateStats() {
            const totalPayPalUSD = paypalTransactions.reduce((sum, t) => sum + t.netAmount, 0);
            const totalStripeUSD = stripeTransactions.reduce((sum, t) => sum + t.netAmount, 0);
            const totalMerchantUSD = Object.values(merchantTransactions).flat().reduce((sum, t) => sum + t.netAmount, 0);
            const totalUSD = totalPayPalUSD + totalStripeUSD + totalMerchantUSD;
            
            const totalPayPalPKR = paypalTransactions.reduce((sum, t) => sum + t.totalPKR, 0);
            const totalStripePKR = stripeTransactions.reduce((sum, t) => sum + t.totalPKR, 0);
            const totalMerchantPKR = Object.values(merchantTransactions).flat().reduce((sum, t) => sum + t.totalPKR, 0);
            const totalPKRFromUSD = totalPayPalPKR + totalStripePKR + totalMerchantPKR;
            
            const totalPKRSpent = pkrTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalPKR = totalPKRFromUSD - totalPKRSpent;
            
            const totalTransactions = paypalTransactions.length + stripeTransactions.length + pkrTransactions.length + Object.values(merchantTransactions).flat().length;
            
            document.getElementById('totalUSD').textContent = `$${totalUSD.toFixed(2)}`;
            document.getElementById('totalPKR').textContent = `${totalPKR.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
        }

        // Charts
        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue (USD)',
                        data: [],
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Payment Methods Chart
            const paymentCtx = document.getElementById('paymentChart').getContext('2d');
            paymentChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgb(59, 130, 246)',
                            'rgb(124, 58, 237)',
                            'rgb(34, 197, 94)',
                            'rgb(249, 115, 22)',
                            'rgb(239, 68, 68)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateCharts() {
            // Update revenue chart with monthly data
            const monthlyData = getMonthlyRevenue();
            revenueChart.data.labels = monthlyData.labels;
            revenueChart.data.datasets[0].data = monthlyData.data;
            revenueChart.update();

            // Update payment methods chart
            const paymentData = getPaymentMethodsData();
            paymentChart.data.labels = paymentData.labels;
            paymentChart.data.datasets[0].data = paymentData.data;
            paymentChart.update();
        }

        function getMonthlyRevenue() {
            const monthlyRevenue = {};
            
            // Combine all transactions
            const allTransactions = [
                ...paypalTransactions,
                ...stripeTransactions,
                ...Object.values(merchantTransactions).flat()
            ];
            
            allTransactions.forEach(transaction => {
                const month = transaction.date.substring(0, 7);
                if (!monthlyRevenue[month]) {
                    monthlyRevenue[month] = 0;
                }
                monthlyRevenue[month] += transaction.netAmount;
            });
            
            const sortedMonths = Object.keys(monthlyRevenue).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                return new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            
            const data = sortedMonths.map(month => monthlyRevenue[month]);
            
            return { labels, data };
        }

        function getPaymentMethodsData() {
            const paypalTotal = paypalTransactions.reduce((sum, t) => sum + t.netAmount, 0);
            const stripeTotal = stripeTransactions.reduce((sum, t) => sum + t.netAmount, 0);
            const merchantTotals = {};
            
            Object.keys(merchantTransactions).forEach(merchantId => {
                const merchant = customMerchants.find(m => m.id == merchantId);
                if (merchant) {
                    merchantTotals[merchant.name] = merchantTransactions[merchantId].reduce((sum, t) => sum + t.netAmount, 0);
                }
            });
            
            const labels = ['PayPal', 'Stripe', ...Object.keys(merchantTotals)];
            const data = [paypalTotal, stripeTotal, ...Object.values(merchantTotals)];
            
            return { labels, data };
        }

        // Export functionality (fees removed from exports)
        function exportToExcel(type) {
            let data = [];
            let filename = '';
            
            if (type === 'paypal') {
                data = paypalTransactions.map(t => ({
                    Date: t.date,
                    'Client Name': t.clientName,
                    'Amount': t.amount,
                    'Net Amount': t.netAmount,
                    'Exchange Rate': t.exchangeRate,
                    'PKR Total': t.totalPKR,
                    'Photo URL': t.photo?.url || 'No photo'
                }));
                filename = 'PayPal_Transactions';
            } else if (type === 'stripe') {
                data = stripeTransactions.map(t => ({
                    Date: t.date,
                    'Client Name': t.clientName,
                    'Amount': t.amount,
                    'Net Amount': t.netAmount,
                    'Exchange Rate': t.exchangeRate,
                    'PKR Total': t.totalPKR,
                    'Photo URL': t.photo?.url || 'No photo'
                }));
                filename = 'Stripe_Transactions';
            } else if (type === 'pkr') {
                data = pkrTransactions.map(t => ({
                    Date: t.date,
                    'Client Name': t.clientName,
                    'PKR Amount': t.amount,
                    'Purpose': t.purpose,
                    'Photo URL': t.photo?.url || 'No photo'
                }));
                filename = 'PKR_Transactions';
            } else if (type === 'merchants') {
                data = [];
                Object.keys(merchantTransactions).forEach(merchantId => {
                    const merchant = customMerchants.find(m => m.id == merchantId);
                    if (merchant) {
                        merchantTransactions[merchantId].forEach(t => {
                            data.push({
                                Merchant: merchant.name,
                                Date: t.date,
                                'Client Name': t.clientName,
                                'Amount': t.amount,
                                'Net Amount': t.netAmount,
                                'Exchange Rate': t.exchangeRate,
                                'PKR Total': t.totalPKR,
                                'Photo URL': t.photo?.url || 'No photo'
                            });
                        });
                    }
                });
                filename = 'Merchant_Transactions';
            }
            
            if (data.length === 0) {
                alert('No transactions to export');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, filename);
            
            const fullFilename = `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fullFilename);
        }

        // Edit modal functions
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingTransaction = null;
        }

        function handleEditSubmit(e) {
            e.preventDefault();
            // Implementation for edit functionality
            closeEditModal();
        }
    </script>
</body>
</html>
