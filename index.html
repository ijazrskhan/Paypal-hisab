<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Multi-Payment Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .chart-container {
            height: 300px;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 5px;
        }
        .success-message {
            color: #10b981;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="text-center">
                <i class="fas fa-user-shield text-4xl text-blue-600 mb-4"></i>
                <h2 class="text-2xl font-bold mb-6">Admin Login</h2>
                <p class="text-gray-600 mb-6">Please enter your credentials</p>
                <form id="loginForm">
                    <div class="mb-4">
                        <input type="text" id="username" placeholder="Username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </button>
                </form>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Header -->
        <div class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-credit-card text-3xl text-blue-600 mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Multi-Payment Dashboard</h1>
                            <p class="text-gray-600">PayPal, Stripe, PKR & Custom Merchant Management</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-file-excel mr-2"></i>Export All Data
                        </button>
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-600">Welcome back</span>
                            <span id="userRole" class="font-bold text-blue-600"></span>
                        </div>
                        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Balance Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">PKR Balance</p>
                            <p class="text-xs text-gray-500">Current available balance</p>
                            <p class="text-2xl font-bold text-blue-600" id="pkrBalance">0 PKR</p>
                        </div>
                        <i class="fas fa-wallet text-3xl text-blue-600"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total USD</p>
                            <p class="text-2xl font-bold text-green-600" id="totalUSD">$0</p>
                        </div>
                        <i class="fas fa-dollar-sign text-3xl text-green-600"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total PKR</p>
                            <p class="text-2xl font-bold text-purple-600" id="totalPKR">0 PKR</p>
                        </div>
                        <i class="fas fa-coins text-3xl text-purple-600"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Transactions</p>
                            <p class="text-2xl font-bold text-orange-600" id="totalTransactions">0</p>
                        </div>
                        <i class="fas fa-exchange-alt text-3xl text-orange-600"></i>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Monthly Revenue Trend</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Payment Methods Distribution</h3>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Transaction Tables -->
            <div class="space-y-8">
                <!-- PayPal USD Transactions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">PayPal USD Transactions</h3>
                        <button id="addPaypalBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="paypalSearch" placeholder="Search transactions..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="table-container">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('paypal', 'date')">Date <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Photo</th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('paypal', 'client')">Client Name <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('paypal', 'amount')">Amount <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Net Amount</th>
                                    <th class="px-4 py-2 text-left">PKR Total</th>
                                    <th class="px-4 py-2 text-left">Invoice #</th>
                                    <th class="px-4 py-2 text-left">Invoice Status</th>
                                    <th class="px-4 py-2 text-left">Invoice Date</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paypalTable">
                                <!-- Transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Stripe USD Transactions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Stripe USD Transactions</h3>
                        <button id="addStripeBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="stripeSearch" placeholder="Search transactions..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="table-container">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('stripe', 'date')">Date <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Photo</th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('stripe', 'client')">Client Name <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('stripe', 'amount')">Amount <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Net Amount</th>
                                    <th class="px-4 py-2 text-left">PKR Total</th>
                                    <th class="px-4 py-2 text-left">Invoice #</th>
                                    <th class="px-4 py-2 text-left">Invoice Status</th>
                                    <th class="px-4 py-2 text-left">Invoice Date</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stripeTable">
                                <!-- Transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PKR Transactions -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">PKR Transactions</h3>
                        <button id="addPkrBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="pkrSearch" placeholder="Search transactions..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="table-container">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('pkr', 'date')">Date <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Photo</th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('pkr', 'client')">Client Name <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('pkr', 'amount')">PKR Amount <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Purpose</th>
                                    <th class="px-4 py-2 text-left">Invoice #</th>
                                    <th class="px-4 py-2 text-left">Invoice Status</th>
                                    <th class="px-4 py-2 text-left">Invoice Date</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pkrTable">
                                <!-- Transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Custom Merchants -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Custom Merchants</h3>
                        <button id="addCustomBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="customSearch" placeholder="Search transactions..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="table-container">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('custom', 'date')">Date <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Photo</th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('custom', 'client')">Client Name <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left cursor-pointer" onclick="sortTable('custom', 'amount')">Amount <i class="fas fa-sort"></i></th>
                                    <th class="px-4 py-2 text-left">Currency</th>
                                    <th class="px-4 py-2 text-left">Merchant</th>
                                    <th class="px-4 py-2 text-left">Invoice #</th>
                                    <th class="px-4 py-2 text-left">Invoice Status</th>
                                    <th class="px-4 py-2 text-left">Invoice Date</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customTable">
                                <!-- Transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Transaction</h2>
            <form id="transactionForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="transactionDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <input type="number" id="amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div id="currencyField" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                        <select id="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="USD">USD</option>
                            <option value="PKR">PKR</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                    <div id="merchantField" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Merchant</label>
                        <input type="text" id="merchant" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="purposeField" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label>
                        <input type="text" id="purpose" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Number</label>
                        <input type="text" id="invoiceNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <div id="invoiceNumberError" class="error-message" style="display: none;"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Link</label>
                        <input type="url" id="invoiceLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <div id="invoiceLinkError" class="error-message" style="display: none;"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Status</label>
                        <select id="invoiceStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="Paid">Paid</option>
                            <option value="Unpaid">Unpaid</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Date</label>
                        <input type="date" id="invoiceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentTransactionType = null;
        let editingTransactionId = null;
        let transactions = {
            paypal: [],
            stripe: [],
            pkr: [],
            custom: []
        };

        // Sample data
        const sampleTransactions = {
            paypal: [
                {
                    id: 1,
                    date: '2024-01-15',
                    client: 'John Doe',
                    amount: 150.00,
                    netAmount: 145.50,
                    pkrTotal: 41580.00,
                    invoiceNumber: 'INV-001',
                    invoiceLink: 'https://example.com/invoice1',
                    invoiceStatus: 'Paid',
                    invoiceDate: '2024-01-15'
                }
            ],
            stripe: [
                {
                    id: 2,
                    date: '2024-01-16',
                    client: 'Jane Smith',
                    amount: 200.00,
                    netAmount: 194.20,
                    pkrTotal: 55440.00,
                    invoiceNumber: 'INV-002',
                    invoiceLink: 'https://example.com/invoice2',
                    invoiceStatus: 'Unpaid',
                    invoiceDate: '2024-01-16'
                }
            ],
            pkr: [
                {
                    id: 3,
                    date: '2024-01-17',
                    client: 'Ahmad Ali',
                    amount: 25000,
                    purpose: 'Web Development',
                    invoiceNumber: 'INV-003',
                    invoiceLink: 'https://example.com/invoice3',
                    invoiceStatus: 'Paid',
                    invoiceDate: '2024-01-17'
                }
            ],
            custom: [
                {
                    id: 4,
                    date: '2024-01-18',
                    client: 'Custom Client',
                    amount: 100.00,
                    currency: 'EUR',
                    merchant: 'Custom Merchant',
                    invoiceNumber: 'INV-004',
                    invoiceLink: 'https://example.com/invoice4',
                    invoiceStatus: 'Paid',
                    invoiceDate: '2024-01-18'
                }
            ]
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load sample data
            transactions = { ...sampleTransactions };
            
            // Initialize login
            initializeLogin();
            
            // Initialize modal handlers
            initializeModals();
            
            // Initialize search handlers
            initializeSearch();
            
            // Initialize export handler
            initializeExport();
        });

        // Login system
        function initializeLogin() {
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Simple authentication (in real app, use proper authentication)
                if ((username === 'admin' && password === 'admin123') || 
                    (username === 'user' && password === 'user123')) {
                    currentUser = username;
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('userRole').textContent = username.charAt(0).toUpperCase() + username.slice(1);
                    
                    // Update UI based on user role
                    updateUIForRole();
                    
                    // Load dashboard data
                    loadDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('loginError').textContent = 'Invalid credentials';
                }
            });
            
            logoutBtn.addEventListener('click', function() {
                currentUser = null;
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginForm').reset();
                document.getElementById('loginError').style.display = 'none';
            });
        }

        // Update UI based on user role
        function updateUIForRole() {
            const isAdmin = currentUser === 'admin';
            const addButtons = document.querySelectorAll('[id$="Btn"]:not(#logoutBtn):not(#exportBtn)');
            
            addButtons.forEach(btn => {
                btn.style.display = isAdmin ? 'block' : 'none';
            });
        }

        // Load dashboard data
        function loadDashboard() {
            updateBalances();
            updateTables();
            updateCharts();
        }

        // Update balance cards
        function updateBalances() {
            let totalUSD = 0;
            let totalPKR = 0;
            let totalTransactions = 0;
            
            // Calculate totals
            transactions.paypal.forEach(t => {
                totalUSD += t.netAmount;
                totalPKR += t.pkrTotal;
                totalTransactions++;
            });
            
            transactions.stripe.forEach(t => {
                totalUSD += t.netAmount;
                totalPKR += t.pkrTotal;
                totalTransactions++;
            });
            
            transactions.pkr.forEach(t => {
                totalPKR += t.amount;
                totalTransactions++;
            });
            
            transactions.custom.forEach(t => {
                if (t.currency === 'USD') {
                    totalUSD += t.amount;
                } else if (t.currency === 'PKR') {
                    totalPKR += t.amount;
                }
                totalTransactions++;
            });
            
            document.getElementById('pkrBalance').textContent = `${totalPKR.toLocaleString()} PKR`;
            document.getElementById('totalUSD').textContent = `$${totalUSD.toLocaleString()}`;
            document.getElementById('totalPKR').textContent = `${totalPKR.toLocaleString()} PKR`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
        }

        // Update transaction tables
        function updateTables() {
            updatePaypalTable();
            updateStripeTable();
            updatePkrTable();
            updateCustomTable();
        }

        // Update PayPal table
        function updatePaypalTable() {
            const tbody = document.getElementById('paypalTable');
            tbody.innerHTML = '';
            
            transactions.paypal.forEach(transaction => {
                const row = createPaypalRow(transaction);
                tbody.appendChild(row);
            });
        }

        // Create PayPal table row
        function createPaypalRow(transaction) {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            
            const statusBadge = transaction.invoiceStatus === 'Paid' ? 
                '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Paid</span>' :
                '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Unpaid</span>';
            
            const actionsHtml = currentUser === 'admin' ? 
                `<button onclick="editTransaction('paypal', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteTransaction('paypal', ${transaction.id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>` : '-';
            
            row.innerHTML = `
                <td class="px-4 py-2">${transaction.date}</td>
                <td class="px-4 py-2">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-500"></i>
                    </div>
                </td>
                <td class="px-4 py-2">${transaction.client}</td>
                <td class="px-4 py-2">$${transaction.amount.toFixed(2)}</td>
                <td class="px-4 py-2">$${transaction.netAmount.toFixed(2)}</td>
                <td class="px-4 py-2">${transaction.pkrTotal.toLocaleString()} PKR</td>
                <td class="px-4 py-2">
                    <a href="${transaction.invoiceLink}" target="_blank" class="text-blue-600 hover:underline">
                        ${transaction.invoiceNumber}
                    </a>
                </td>
                <td class="px-4 py-2">${statusBadge}</td>
                <td class="px-4 py-2">${transaction.invoiceDate}</td>
                <td class="px-4 py-2">${actionsHtml}</td>
            `;
            
            return row;
        }

        // Update Stripe table
        function updateStripeTable() {
            const tbody = document.getElementById('stripeTable');
            tbody.innerHTML = '';
            
            transactions.stripe.forEach(transaction => {
                const row = createStripeRow(transaction);
                tbody.appendChild(row);
            });
        }

        // Create Stripe table row
        function createStripeRow(transaction) {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            
            const statusBadge = transaction.invoiceStatus === 'Paid' ? 
                '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Paid</span>' :
                '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Unpaid</span>';
            
            const actionsHtml = currentUser === 'admin' ? 
                `<button onclick="editTransaction('stripe', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteTransaction('stripe', ${transaction.id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>` : '-';
            
            row.innerHTML = `
                <td class="px-4 py-2">${transaction.date}</td>
                <td class="px-4 py-2">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-500"></i>
                    </div>
                </td>
                <td class="px-4 py-2">${transaction.client}</td>
                <td class="px-4 py-2">$${transaction.amount.toFixed(2)}</td>
                <td class="px-4 py-2">$${transaction.netAmount.toFixed(2)}</td>
                <td class="px-4 py-2">${transaction.pkrTotal.toLocaleString()} PKR</td>
                <td class="px-4 py-2">
                    <a href="${transaction.invoiceLink}" target="_blank" class="text-blue-600 hover:underline">
                        ${transaction.invoiceNumber}
                    </a>
                </td>
                <td class="px-4 py-2">${statusBadge}</td>
                <td class="px-4 py-2">${transaction.invoiceDate}</td>
                <td class="px-4 py-2">${actionsHtml}</td>
            `;
            
            return row;
        }

        // Update PKR table
        function updatePkrTable() {
            const tbody = document.getElementById('pkrTable');
            tbody.innerHTML = '';
            
            transactions.pkr.forEach(transaction => {
                const row = createPkrRow(transaction);
                tbody.appendChild(row);
            });
        }

        // Create PKR table row
        function createPkrRow(transaction) {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            
            const statusBadge = transaction.invoiceStatus === 'Paid' ? 
                '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Paid</span>' :
                '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Unpaid</span>';
            
            const actionsHtml = currentUser === 'admin' ? 
                `<button onclick="editTransaction('pkr', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteTransaction('pkr', ${transaction.id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>` : '-';
            
            row.innerHTML = `
                <td class="px-4 py-2">${transaction.date}</td>
                <td class="px-4 py-2">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-500"></i>
                    </div>
                </td>
                <td class="px-4 py-2">${transaction.client}</td>
                <td class="px-4 py-2">${transaction.amount.toLocaleString()} PKR</td>
                <td class="px-4 py-2">${transaction.purpose}</td>
                <td class="px-4 py-2">
                    <a href="${transaction.invoiceLink}" target="_blank" class="text-blue-600 hover:underline">
                        ${transaction.invoiceNumber}
                    </a>
                </td>
                <td class="px-4 py-2">${statusBadge}</td>
                <td class="px-4 py-2">${transaction.invoiceDate}</td>
                <td class="px-4 py-2">${actionsHtml}</td>
            `;
            
            return row;
        }

        // Update Custom table
        function updateCustomTable() {
            const tbody = document.getElementById('customTable');
            tbody.innerHTML = '';
            
            transactions.custom.forEach(transaction => {
                const row = createCustomRow(transaction);
                tbody.appendChild(row);
            });
        }

        // Create Custom table row
        function createCustomRow(transaction) {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            
            const statusBadge = transaction.invoiceStatus === 'Paid' ? 
                '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Paid</span>' :
                '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Unpaid</span>';
            
            const actionsHtml = currentUser === 'admin' ? 
                `<button onclick="editTransaction('custom', ${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteTransaction('custom', ${transaction.id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>` : '-';
            
            row.innerHTML = `
                <td class="px-4 py-2">${transaction.date}</td>
                <td class="px-4 py-2">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-500"></i>
                    </div>
                </td>
                <td class="px-4 py-2">${transaction.client}</td>
                <td class="px-4 py-2">${transaction.amount.toLocaleString()} ${transaction.currency}</td>
                <td class="px-4 py-2">${transaction.currency}</td>
                <td class="px-4 py-2">${transaction.merchant}</td>
                <td class="px-4 py-2">
                    <a href="${transaction.invoiceLink}" target="_blank" class="text-blue-600 hover:underline">
                        ${transaction.invoiceNumber}
                    </a>
                </td>
                <td class="px-4 py-2">${statusBadge}</td>
                <td class="px-4 py-2">${transaction.invoiceDate}</td>
                <td class="px-4 py-2">${actionsHtml}</td>
            `;
            
            return row;
        }

        // Initialize modal handlers
        function initializeModals() {
            const modal = document.getElementById('transactionModal');
            const closeBtn = document.querySelector('.close');
            const cancelBtn = document.getElementById('cancelBtn');
            const form = document.getElementById('transactionForm');
            
            // Add transaction buttons
            document.getElementById('addPaypalBtn').addEventListener('click', () => openTransactionModal('paypal'));
            document.getElementById('addStripeBtn').addEventListener('click', () => openTransactionModal('stripe'));
            document.getElementById('addPkrBtn').addEventListener('click', () => openTransactionModal('pkr'));
            document.getElementById('addCustomBtn').addEventListener('click', () => openTransactionModal('custom'));
            
            // Close modal handlers
            closeBtn.addEventListener('click', closeTransactionModal);
            cancelBtn.addEventListener('click', closeTransactionModal);
            
            // Form submission
            form.addEventListener('submit', handleTransactionSubmit);
            
            // Invoice validation
            document.getElementById('invoiceNumber').addEventListener('blur', validateInvoiceNumber);
            document.getElementById('invoiceLink').addEventListener('blur', validateInvoiceLink);
        }

        // Open transaction modal
        function openTransactionModal(type) {
            currentTransactionType = type;
            editingTransactionId = null;
            
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('transactionForm');
            
            title.textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)} Transaction`;
            
            // Show/hide fields based on type
            const currencyField = document.getElementById('currencyField');
            const merchantField = document.getElementById('merchantField');
            const purposeField = document.getElementById('purposeField');
            
            currencyField.style.display = type === 'custom' ? 'block' : 'none';
            merchantField.style.display = type === 'custom' ? 'block' : 'none';
            purposeField.style.display = type === 'pkr' ? 'block' : 'none';
            
            // Reset form
            form.reset();
            clearValidationErrors();
            
            modal.style.display = 'block';
        }

        // Close transaction modal
        function closeTransactionModal() {
            document.getElementById('transactionModal').style.display = 'none';
            currentTransactionType = null;
            editingTransactionId = null;
        }

        // Handle transaction form submission
        function handleTransactionSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const formData = getFormData();
            
            if (editingTransactionId) {
                updateTransaction(formData);
            } else {
                addTransaction(formData);
            }
            
            closeTransactionModal();
            loadDashboard();
        }

        // Get form data
        function getFormData() {
            const data = {
                date: document.getElementById('transactionDate').value,
                client: document.getElementById('clientName').value,
                amount: parseFloat(document.getElementById('amount').value),
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceLink: document.getElementById('invoiceLink').value,
                invoiceStatus: document.getElementById('invoiceStatus').value,
                invoiceDate: document.getElementById('invoiceDate').value
            };
            
            if (currentTransactionType === 'custom') {
                data.currency = document.getElementById('currency').value;
                data.merchant = document.getElementById('merchant').value;
            }
            
            if (currentTransactionType === 'pkr') {
                data.purpose = document.getElementById('purpose').value;
            }
            
            // Calculate derived values
            if (currentTransactionType === 'paypal' || currentTransactionType === 'stripe') {
                data.netAmount = data.amount * 0.97; // 3% fee
                data.pkrTotal = data.netAmount * 277; // Sample exchange rate
            }
            
            return data;
        }

        // Add transaction
        function addTransaction(data) {
            const id = Date.now();
            transactions[currentTransactionType].push({ id, ...data });
        }

        // Update transaction
        function updateTransaction(data) {
            const index = transactions[currentTransactionType].findIndex(t => t.id === editingTransactionId);
            if (index !== -1) {
                transactions[currentTransactionType][index] = { id: editingTransactionId, ...data };
            }
        }

        // Edit transaction
        function editTransaction(type, id) {
            const transaction = transactions[type].find(t => t.id === id);
            if (!transaction) return;
            
            currentTransactionType = type;
            editingTransactionId = id;
            
            // Fill form with transaction data
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('clientName').value = transaction.client;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('invoiceNumber').value = transaction.invoiceNumber;
            document.getElementById('invoiceLink').value = transaction.invoiceLink;
            document.getElementById('invoiceStatus').value = transaction.invoiceStatus;
            document.getElementById('invoiceDate').value = transaction.invoiceDate;
            
            if (type === 'custom') {
                document.getElementById('currency').value = transaction.currency;
                document.getElementById('merchant').value = transaction.merchant;
            }
            
            if (type === 'pkr') {
                document.getElementById('purpose').value = transaction.purpose;
            }
            
            // Open modal
            openTransactionModal(type);
            document.getElementById('modalTitle').textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)} Transaction`;
        }

        // Delete transaction
        function deleteTransaction(type, id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions[type] = transactions[type].filter(t => t.id !== id);
                loadDashboard();
            }
        }

        // Validate form
        function validateForm() {
            let isValid = true;
            
            // Validate invoice number uniqueness
            if (!validateInvoiceNumber()) {
                isValid = false;
            }
            
            // Validate invoice link uniqueness
            if (!validateInvoiceLink()) {
                isValid = false;
            }
            
            return isValid;
        }

        // Validate invoice number uniqueness
        function validateInvoiceNumber() {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const errorElement = document.getElementById('invoiceNumberError');
            
            // Check uniqueness across all transactions
            const allTransactions = [
                ...transactions.paypal,
                ...transactions.stripe,
                ...transactions.pkr,
                ...transactions.custom
            ];
            
            const duplicate = allTransactions.find(t => 
                t.invoiceNumber === invoiceNumber && 
                t.id !== editingTransactionId
            );
            
            if (duplicate) {
                errorElement.textContent = 'Invoice number already exists';
                errorElement.style.display = 'block';
                return false;
            }
            
            errorElement.style.display = 'none';
            return true;
        }

        // Validate invoice link uniqueness
        function validateInvoiceLink() {
            const invoiceLink = document.getElementById('invoiceLink').value;
            const errorElement = document.getElementById('invoiceLinkError');
            
            // Check uniqueness across all transactions
            const allTransactions = [
                ...transactions.paypal,
                ...transactions.stripe,
                ...transactions.pkr,
                ...transactions.custom
            ];
            
            const duplicate = allTransactions.find(t => 
                t.invoiceLink === invoiceLink && 
                t.id !== editingTransactionId
            );
            
            if (duplicate) {
                errorElement.textContent = 'Invoice link already exists';
                errorElement.style.display = 'block';
                return false;
            }
            
            errorElement.style.display = 'none';
            return true;
        }

        // Clear validation errors
        function clearValidationErrors() {
            document.getElementById('invoiceNumberError').style.display = 'none';
            document.getElementById('invoiceLinkError').style.display = 'none';
        }

        // Initialize search functionality
        function initializeSearch() {
            document.getElementById('paypalSearch').addEventListener('input', (e) => searchTransactions('paypal', e.target.value));
            document.getElementById('stripeSearch').addEventListener('input', (e) => searchTransactions('stripe', e.target.value));
            document.getElementById('pkrSearch').addEventListener('input', (e) => searchTransactions('pkr', e.target.value));
            document.getElementById('customSearch').addEventListener('input', (e) => searchTransactions('custom', e.target.value));
        }

        // Search transactions
        function searchTransactions(type, query) {
            const table = document.getElementById(`${type}Table`);
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                
                if (text.includes(query.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Sort table
        function sortTable(type, column) {
            const data = [...transactions[type]];
            
            data.sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];
                
                if (column === 'amount') {
                    return aValue - bValue;
                } else if (column === 'date') {
                    return new Date(aValue) - new Date(bValue);
                } else {
                    return aValue.localeCompare(bValue);
                }
            });
            
            transactions[type] = data;
            updateTables();
        }

        // Initialize export functionality
        function initializeExport() {
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
        }

        // Export to Excel
        function exportToExcel() {
            const workbook = XLSX.utils.book_new();
            
            // Create sheets for each transaction type
            const paypalSheet = XLSX.utils.json_to_sheet(transactions.paypal.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                Amount: t.amount,
                'Net Amount': t.netAmount,
                'PKR Total': t.pkrTotal,
                'Invoice Number': t.invoiceNumber,
                'Invoice Link': t.invoiceLink,
                'Invoice Status': t.invoiceStatus,
                'Invoice Date': t.invoiceDate
            })));
            
            const stripeSheet = XLSX.utils.json_to_sheet(transactions.stripe.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                Amount: t.amount,
                'Net Amount': t.netAmount,
                'PKR Total': t.pkrTotal,
                'Invoice Number': t.invoiceNumber,
                'Invoice Link': t.invoiceLink,
                'Invoice Status': t.invoiceStatus,
                'Invoice Date': t.invoiceDate
            })));
            
            const pkrSheet = XLSX.utils.json_to_sheet(transactions.pkr.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                'PKR Amount': t.amount,
                Purpose: t.purpose,
                'Invoice Number': t.invoiceNumber,
                'Invoice Link': t.invoiceLink,
                'Invoice Status': t.invoiceStatus,
                'Invoice Date': t.invoiceDate
            })));
            
            const customSheet = XLSX.utils.json_to_sheet(transactions.custom.map(t => ({
                Date: t.date,
                'Client Name': t.client,
                Amount: t.amount,
                Currency: t.currency,
                Merchant: t.merchant,
                'Invoice Number': t.invoiceNumber,
                'Invoice Link': t.invoiceLink,
                'Invoice Status': t.invoiceStatus,
                'Invoice Date': t.invoiceDate
            })));
            
            // Add sheets to workbook
            XLSX.utils.book_append_sheet(workbook, paypalSheet, 'PayPal');
            XLSX.utils.book_append_sheet(workbook, stripeSheet, 'Stripe');
            XLSX.utils.book_append_sheet(workbook, pkrSheet, 'PKR');
            XLSX.utils.book_append_sheet(workbook, customSheet, 'Custom');
            
            // Export file
            XLSX.writeFile(workbook, 'payment_dashboard_export.xlsx');
        }

        // Update charts
        function updateCharts() {
            updateRevenueChart();
            updateDistributionChart();
        }

        // Update revenue chart
        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Sample data for demonstration
            const monthlyData = [
                { month: 'Jan', revenue: 5000 },
                { month: 'Feb', revenue: 7500 },
                { month: 'Mar', revenue: 6200 },
                { month: 'Apr', revenue: 8100 },
                { month: 'May', revenue: 9300 },
                { month: 'Jun', revenue: 11200 }
            ];
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.map(d => d.month),
                    datasets: [{
                        label: 'Revenue',
                        data: monthlyData.map(d => d.revenue),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update distribution chart
        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            const data = {
                labels: ['PayPal', 'Stripe', 'PKR', 'Custom'],
                datasets: [{
                    data: [
                        transactions.paypal.length,
                        transactions.stripe.length,
                        transactions.pkr.length,
                        transactions.custom.length
                    ],
                    backgroundColor: [
                        'rgb(59, 130, 246)',
                        'rgb(16, 185, 129)',
                        'rgb(139, 92, 246)',
                        'rgb(245, 101, 101)'
                    ]
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
